<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Démonstration d'appel de l'API PictureSearchEngine</title>

    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-149843481-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-149843481-2');
</script>


</head>
<body style="text-align: center;background-color: lightgray;" onload="search()">
<h2>Client test de l'API PSE (PictureSearchEngine)</h2>

<a href="javascript:search()">Recherche</a>
<div id="zone_respons"></div>
<br><br>
<br>
Copyrith F80 - 2019<br>
<a href="mailto:contact@f80.fr">Hervé HOAREAU</a>

<script>

    //Fonction de récupération des paramètres de l'URL
    function getParams() {
        var vars = {};
        window.location.href.replace( location.hash, '' ).replace(
            /[?&]+([^=&]+)=?([^&]*)?/gi, // regexp
            function( m, key, value ) { // callback
                vars[key] = value !== undefined ? value : '';
            }
        );
        return vars;
    }


    /**
     * Fonction permettant la récupération du token d'accès à l'API
     * @param domain domaine de l'API
     * @param username
     * @param password
     * @param func fonction de callback
     */
    function getToken(domain,username,password,func){
        fetch(domain+"/auth",{
                method:'POST',
                headers: new Headers({
                    "Content-Type":"application/json",
                    "Cache-Control":"no-cache",
                    "Accept":"*/*"
                }),
                body:JSON.stringify({
                    "username":username,
                    "password":password
                })
            }).then((r)=>{
                r.json().then((result)=>{func(result.access_token);})
            });
    }

    //La localisation du serveur est passé en argument de la page de test
    var server=getParams().server || "https://server.f80.fr";
    var port=getParams().port || 5800;
    var url=server+":"+port;
    if(!url.startsWith("http"))url="http://"+url;

    function search(){
    getToken(url,"demo","demo_password",(token)=>{
        console.log("Token récupéré = "+token);

        var query=prompt("Des images de quoi (1 seul mot) ?");
        if(query!=null && query.length>2){
            query=query.split(" ")[0].trim();//On ne conserve que le premier mot

            //Si la requête est bien valable, on appele l'API. Le token est passé dans le header
            fetch(url+"/api/"+query+"?limit=10&quality=true",{headers:new Headers({'Authorization':"JWT "+token})}).then((r)=>{
                r.json().then((result)=>{
                    var zone=document.getElementById("zone_respons");
                    if(result.length==0){
                        zone.innerHTML="Aucune réponse à la recherche sur "+query;
                    } else {
                        for(let r of result){
                            zone.innerHTML+="<img style='display:inline-bloc;margin:10px;width:300px;' src='"+r+"'><br>";
                        }
                    }
                });
            });
        }
    });
    }

</script>
</body>
</html>
